'use strict';var recLength=0,recBuffer=[],recordSampleRate;self.addEventListener("message",function(a){switch(a.data.command){case "init":init(a.data.config);break;case "record":record(a.data.buffer);break;case "export":exportBuffer(a.data.sampleRate);break;case "clear":clear()}});function init(a){recordSampleRate=a.sampleRate}function record(a){recBuffer.push(a[0]);recLength+=a[0].length}
function exportBuffer(a){var b=mergeBuffers(recBuffer,recLength);a=downsampleBuffer(b,a);a=encodeWAV(a);a=new Blob([a],{type:"application/octet-stream"});postMessage(a)}function clear(){recLength=0;recBuffer=[]}function downsampleBuffer(a,b){if(b===recordSampleRate)return a;b=recordSampleRate/b;for(var d=new Float32Array(Math.round(a.length/b)),c=0,e=0;c<d.length;){for(var f=Math.round((c+1)*b),g=0,h=0;e<f&&e<a.length;e++)g+=a[e],h++;d[c]=g/h;c++;e=f}return d}
function mergeBuffers(a,b){b=new Float32Array(b);for(var d=0,c=0;c<a.length;c++)b.set(a[c],d),d+=a[c].length;return b}function floatTo16BitPCM(a,b,d){for(var c=0;c<d.length;c++,b+=2){var e=Math.max(-1,Math.min(1,d[c]));a.setInt16(b,0>e?32768*e:32767*e,!0)}}function writeString(a,b,d){for(var c=0;c<d.length;c++)a.setUint8(b+c,d.charCodeAt(c))}
function encodeWAV(a){var b=new ArrayBuffer(44+2*a.length);b=new DataView(b);writeString(b,0,"RIFF");b.setUint32(4,32+2*a.length,!0);writeString(b,8,"WAVE");writeString(b,12,"fmt ");b.setUint32(16,16,!0);b.setUint16(20,1,!0);b.setUint16(22,1,!0);b.setUint32(24,recordSampleRate,!0);b.setUint32(28,2*recordSampleRate,!0);b.setUint16(32,2,!0);b.setUint16(34,16,!0);writeString(b,36,"data");b.setUint32(40,2*a.length,!0);floatTo16BitPCM(b,44,a);return b};
